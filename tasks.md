# tasks.md — Пошаговая декомпозиция

---

## ШАГ 1: Скелет проекта и game loop
**Файлы:** index.html, js/main.js, js/config.js
**Что делаем:**
- HTML-страница с `<canvas>` 960×600
- Canvas контекст 2D
- Game loop через `requestAnimationFrame`
- FPS-счётчик на экране
- Заливка canvas чёрным цветом каждый кадр
- config.js с константами: SCREEN_WIDTH=960, SCREEN_HEIGHT=600,
  VIEWPORT_X=160, VIEWPORT_Y=20, VIEWPORT_W=640, VIEWPORT_H=400

**Критерий готовности:**
- Открываешь index.html — видишь чёрный canvas
- В углу мигает FPS ~60
- В консоли нет ошибок

---

## ШАГ 2: Обработка ввода
**Файлы:** js/input.js, обновить js/main.js
**Что делаем:**
- Модуль Input: слушает keydown/keyup
- Хранит состояние клавиш в объекте `keys = {}`
- Маппинг: W/↑=forward, S/↓=backward, A/←=turnLeft, D/→=turnRight,
  Q=strafeLeft, E=strafeRight, Space=shoot, Tab=map, 1-7=weapon select
- Отображать на canvas текст "Pressed: W, A..." для дебага

**Критерий готовности:**
- Нажимаешь клавиши — на экране появляются их названия в реальном времени
- Отпускаешь — пропадают
- Нет залипаний

---

## ШАГ 3: Карта уровня и 2D-отладочный вид
**Файлы:** js/map.js, обновить main.js
**Что делаем:**
- Карта уровня как 2D-массив 20×20
  - 0 = пустота (проход)
  - 1-5 = стены разных типов (разные цвета)
  - 9 = дверь
- Нарисовать карту на canvas в 2D виде сверху (каждая ячейка = 16×16 px)
- Показать позицию игрока (кружок) и направление взгляда (линия)
- Тестовая карта: комната с коридорами, пара поворотов, тупики

**Критерий готовности:**
- Видна цветная сетка карты
- Видна точка игрока в стартовой позиции
- Стены разных типов — разные цвета

---

## ШАГ 4: Движение игрока (2D)
**Файлы:** js/player.js, обновить main.js
**Что делаем:**
- Player: x, y, angle, moveSpeed, rotSpeed
- Вперёд/назад — по вектору направления
- Поворот влево/вправо — изменение angle
- Стрейф — перпендикулярно направлению
- Коллизия со стенами: проверка ячейки карты перед перемещением
  (с зазором 0.2, чтобы не проваливаться в стены)
- Всё видно на 2D-карте: точка двигается, линия поворачивается

**Критерий готовности:**
- WASD/стрелки двигают точку по карте
- Точка НЕ проходит сквозь стены
- Поворот плавный
- Стрейф работает

---

## ШАГ 5: Рейкастинг — отрисовка стен
**Файлы:** js/raycaster.js, js/renderer.js, обновить main.js
**Что делаем:**
- Реализовать DDA raycasting алгоритм
- Для каждого столбца пикселей viewport'а:
  - Бросить луч от позиции игрока
  - Найти пересечение со стеной (DDA)
  - Вычислить расстояние до стены (с коррекцией fish-eye)
  - Вычислить высоту полоски стены
  - Нарисовать вертикальную полоску
- Стены — ОДНОЦВЕТНЫЕ (пока без текстур), цвет зависит от типа стены
- Боковые стены чуть темнее (для объёма)
- Потолок = тёмно-серый, пол = серый
- 3D-viewport рисуется в области VIEWPORT_X/Y/W/H из config
- РЯДОМ оставить 2D-миникарту (для дебага)

**Критерий готовности:**
- Видна 3D-перспектива коридоров
- Стены корректной высоты (ближние — большие, дальние — маленькие)
- Нет fish-eye искажения
- Повороты и движение — плавные
- FPS ≥ 30

---

## ШАГ 6: Текстурирование стен
**Файлы:** обновить raycaster.js, renderer.js, добавить генерацию текстур
**Что делаем:**
- Генерировать текстуры программно (64×64 px):
  - Тип 1: металлическая панель (серая с линиями)
  - Тип 2: кирпичи (красно-коричневые)
  - Тип 3: техническая панель (серая с цветными элементами)
  - Тип 4: бетон (серый шум)
  - Тип 5: дверь (тёмная с полоской)
- При рейкасте: определить точку попадания на текстуре (U-координата)
- Рисовать текстурированные столбцы (попиксельно или через ImageData)
- Distance shading: чем дальше стена, тем темнее

**Критерий готовности:**
- Стены покрыты текстурами
- Разные типы стен имеют разные текстуры
- Видно затемнение вдали
- FPS ≥ 25

---

## ШАГ 7: Двери
**Файлы:** обновить map.js, raycaster.js, player.js
**Что делаем:**
- Ячейка карты type=9 → дверь
- Дверь имеет состояние: closed, opening, open, closing
- При подходе игрока вплотную + нажатие Space → дверь открывается (анимация: сдвиг текстуры)
- Через 3 секунды без игрока рядом → закрывается
- Рейкаст учитывает состояние двери (открытая = проход)

**Критерий готовности:**
- Двери видны как отдельный тип стены
- Space открывает дверь
- Можно пройти через открытую дверь
- Дверь закрывается автоматически

---

## ШАГ 8: HUD-рамка
**Файлы:** обновить renderer.js, добавить HUD-логику
**Что делаем:**
- Вокруг 3D-viewport нарисовать рамку в стиле sci-fi
- Элементы HUD (пока с заглушками):
  - HP-бар (слева внизу): зелёная полоска
  - Armor-бар: синяя полоска
  - Текущее оружие (текст + иконка-заглушка)
  - Патроны (число)
  - Enemies Left: число (пока = 0)
  - Портрет персонажа (цветной квадрат-заглушка)
  - Мини-компас (линия направления)
- Все значения берутся из player state

**Критерий готовности:**
- 3D-окно обрамлено HUD'ом
- Видны все элементы с заглушечными данными
- HP-бар меняется, если менять player.hp вручную
- Выглядит как интерфейс игры

---

## ШАГ 9: Система оружия (без врагов)
**Файлы:** js/weapons.js, обновить player.js, renderer.js
**Что делаем:**
- 7 типов оружия (объекты с параметрами):
  damage, fireRate, ammoType, ammoPerShot, isAutomatic, spread
- Игрок имеет: currentWeapon, ammo = {pistol:∞, shells:20, rifle:0...}
- Переключение: клавиши 1-7 (только если есть это оружие)
- Стрельба: Space, cooldown по fireRate
- Анимация выстрела: мерцание/flash в нижней части viewport
- Отрисовка «руки с оружием» внизу viewport
  (простая геометрия — прямоугольники, рисуем программно)
- HUD обновляется: текущее оружие, патроны

**Критерий готовности:**
- Клавиши 1-3 переключают оружие (стартовые 3)
- Space стреляет (видна анимация)
- Патроны расходуются (кроме пистолета)
- HUD показывает актуальное оружие и патроны

---

## ШАГ 10: Система спрайтов (предметы)
**Файлы:** js/sprites.js, js/items.js, обновить renderer.js, raycaster.js
**Что делаем:**
- Спрайты — 2D-объекты в 3D-мире (billboarded)
- Каждый спрайт: x, y, type, texture
- Рендер: трансформация в пространство камеры, проекция, отрисовка
- Z-buffer (массив расстояний от рейкаста) для корректного перекрытия стенами
- Типы предметов: healthSmall, healthBig, armor, ammoShells, ammoRifle, weaponShotgun
- Генерация спрайтов программно (цветные фигуры: крест=аптечка, квадрат=патроны)
- Подбор: при приближении игрока (расстояние < 0.5) → эффект + удаление
- Разместить 5-6 предметов на тестовой карте

**Критерий готовности:**
- Предметы видны в 3D как спрайты
- Спрайты корректно перекрываются стенами
- Спрайты всегда лицом к камере
- Подбор работает: HP растёт, патроны добавляются
- Подобранный спрайт исчезает

---

## ШАГ 11: Враги — рендеринг и размещение
**Файлы:** js/enemies.js, обновить sprites.js, renderer.js
**Что делаем:**
- Enemy: x, y, hp, type, state, sprite
- Типы: zombie (зелёный), soldier (красный), alien (фиолетовый)
- Спрайты врагов — генерируем программно:
  гуманоидный силуэт разных цветов (простая пиксельная фигура)
- Враги рендерятся через систему спрайтов (z-сортировка)
- Пока враги СТОЯТ НА МЕСТЕ (state = IDLE)
- Разместить 5 врагов на карте
- Счётчик Enemies Left в HUD показывает количество живых

**Критерий готовности:**
- Враги видны в 3D
- Корректно перекрываются стенами и между собой
- Enemies Left = 5 на старте
- Враги разных типов отличаются визуально

---

## ШАГ 12: Стрельба по врагам
**Файлы:** обновить weapons.js, enemies.js, player.js
**Что делаем:**
- При выстреле: raycast от игрока по центру экрана
- Проверка попадания: луч пересекает спрайт врага?
  (проверка по расстоянию и углу — хитбокс)
- При попадании: враг теряет HP, визуальная реакция (мерцание красным)
- HP врага ≤ 0 → анимация смерти (спрайт меняется на «труп»,
  через 0.5с исчезает или остаётся на полу)
- Enemies Left уменьшается
- Звуковой маркер попадания (пока console.log)

**Критерий готовности:**
- Стрельба в врага наносит урон
- Враг мигает при попадании
- Враг умирает после достаточного урона
- Enemies Left корректно обновляется
- Стрельба в пустоту — промах, ничего не происходит

---

## ШАГ 13: AI врагов
**Файлы:** обновить enemies.js
**Что делаем:**
- Состояния: IDLE → ALERT → CHASE → ATTACK → PAIN → DEAD
- IDLE: стоит на месте
- ALERT: при line-of-sight к игроку (raycast от врага к игроку,
  проверка что нет стен на пути) → переход в CHASE
- CHASE: двигается к игроку (по прямой, с проверкой коллизий со стенами)
- ATTACK: в радиусе атаки → наносить урон игроку каждые N секунд
  - Ближняя атака (zombie): радиус 1.0
  - Дальняя атака (soldier): радиус 8.0, hitscan
- PAIN: при получении урона → пауза 0.3с
- Вражеский урон отображается: HP игрока падает, экран мигает красным

**Критерий готовности:**
- Враги замечают игрока при прямой видимости
- Зомби бегут к игроку и бьют вблизи
- Солдаты стреляют издалека
- Игрок получает урон (HP падает, экран мигает)
- Враги застревают в стенах? → НЕТ, коллизии работают

---

## ШАГ 14: Смерть игрока и система персонажей
**Файлы:** js/ui.js, обновить player.js, main.js
**Что делаем:**
- 5 персонажей: массив объектов {name, hp, speed, armor, startWeapon, alive}
- Экран выбора персонажа перед игрой:
  - Отрисовка списка с характеристиками
  - Мёртвые — затемнены
  - Клавиши ↑↓ + Enter
- При HP игрока ≤ 0:
  - Экран "K.I.A." с именем
  - Персонаж помечается alive=false
  - Переход к экрану выбора следующего
- Все мертвы → Game Over экран
- HUD-портрет меняется в зависимости от персонажа

**Критерий готовности:**
- Перед игрой — экран выбора из 5 персонажей
- У персонажей разная скорость/HP
- Смерть → экран KIA → выбор следующего
- Все мертвы → Game Over
- Game Over → можно начать заново

---

## ШАГ 15: Система уровней и переходы
**Файлы:** js/levels.js, обновить map.js, main.js
**Что делаем:**
- 3 тестовых уровня (разные карты 20×20)
- Каждый уровень: карта + список врагов + список предметов + стартовая позиция
- Лифт (специальная ячейка карты type=8):
  - Активируется ТОЛЬКО когда Enemies Left = 0
  - Визуально мерцает когда доступен
  - При входе → экран "Level Complete" → загрузка следующего уровня
- Между уровнями: сохраняется состояние игрока (HP, оружие, патроны)
- Последний уровень → экран "Victory"

**Критерий готовности:**
- 3 разных уровня загружаются последовательно
- Лифт заблокирован пока есть враги
- Лифт открывается при зачистке
- Переход сохраняет HP/оружие
- Финальный экран победы

---

## ШАГ 16: Автокарта (Automap)
**Файлы:** обновить renderer.js, map.js
**Что делаем:**
- Tab → оверлей поверх viewport
- Отображение: посещённые ячейки, стены, двери, позиция игрока
- Fog-of-war: непосещённые зоны = чёрные
- Полупрозрачный фон (alpha)
- Tab снова → закрыть

**Критерий готовности:**
- Tab открывает карту
- Видны только посещённые зоны
- Позиция и направление игрока видны
- Tab закрывает карту

---

## ШАГ 17: Главное меню и пароли
**Файлы:** обновить ui.js, main.js
**Что делаем:**
- Главное меню: NEW GAME, PASSWORD, OPTIONS
- Система паролей: после каждого уровня показывается 8-символьный пароль
- Пароль кодирует: номер уровня, живых персонажей
- Ввод пароля: экран с клавиатурой (A-Z, 0-9, стрелки)
- OPTIONS: громкость (заглушка)
- Game states: MENU → CHARACTER_SELECT → PLAYING → PAUSED → LEVEL_COMPLETE → GAME_OVER

**Критерий готовности:**
- Игра начинается с меню
- NEW GAME → выбор персонажа → игра
- Пароль показывается после уровня
- Пароль можно ввести и попасть на нужный уровень

---

## ШАГ 18: Звуковая система
**Файлы:** js/audio.js, обновить main.js
**Что делаем:**
- Web Audio API
- Генерация звуков программно (oscillator + noise):
  - Выстрел пистолета, дробовика, автомата
  - Попадание
  - Подбор предмета
  - Открытие двери
  - Смерть врага (3 варианта)
  - Получение урона игроком
  - Лифт
- Фоновая музыка: простой procedural ambient (низкочастотный гул + редкие тона)
- Громкость зависит от расстояния (для врагов)

**Критерий готовности:**
- Все действия озвучены
- Фоновая музыка играет
- Звуки не «залипают» и не накладываются критично
- Можно играть без звука (ошибок нет)

---

## ШАГ 19: Контент — полноценные уровни
**Файлы:** обновить levels.js, enemies.js, items.js
**Что делаем:**
- Создать 9 уровней (3 главы × 3 уровня):
  - Глава 1 "Станция": узкие коридоры, слабые враги
  - Глава 2 "Небоскрёб": открытые пространства, средние враги
  - Глава 3 "Подземелье": лабиринты, сильные враги
- Финальный босс на уровне 9 (много HP, быстрый, сильный урон)
- Прогрессия сложности
- Уникальные текстуры для каждой главы (перегенерация палитры)
- Размещение оружия: дробовик — уровень 2, автомат — уровень 4, ракетница — уровень 7

**Критерий готовности:**
- 9 уровней проходятся от начала до конца
- Сложность нарастает
- Босс на последнем уровне
- Полное прохождение занимает 20-40 минут

---

## ШАГ 20: Полировка и баланс
**Что делаем:**
- Экран мигает красным при уроне
- Distance fog (затемнение)
- Плавные переходы между экранами (fade)
- Баланс: HP врагов, урон оружия, количество патронов
- Мерцание портрета при низком HP
- «Кровавые» следы на стенах (текстурные вариации)
- Финальные титры после победы
- Проверка всех edge-кейсов

**Критерий готовности:**
- Игра проходима от меню до финальных титров
- Нет критических багов
- FPS стабильный ≥ 30
- Баланс комфортный
```

---