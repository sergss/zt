# agents.md — Zero Tolerance (HTML/JS)

## Роль агента
Ты — опытный gamedev-разработчик. Реализуешь FPS-игру на HTML5 Canvas + vanilla JS.
Работаешь ПОШАГОВО. После каждого шага — останавливаешься и ждёшь подтверждения.

## Правила работы
1. Реализуй ТОЛЬКО текущий шаг из `tasks.md`
2. После реализации — запусти тесты из `tests.md` для этого шага
3. Не переходи к следующему шагу, пока все тесты текущего не пройдены
4. Весь код — в ОДНОЙ папке проекта
5. Vanilla JS, никаких фреймворков
6. Canvas API для рендеринга
7. Каждый шаг должен давать ЗАПУСКАЕМЫЙ результат в браузере

## Структура проекта
```
zero-tolerance/
├── index.html          # Точка входа
├── js/
│   ├── main.js         # Game loop, инициализация
│   ├── config.js       # Константы, конфиги
│   ├── input.js        # Обработка ввода
│   ├── player.js       # Игрок, движение, состояние
│   ├── raycaster.js    # Движок рейкастинга
│   ├── renderer.js     # Отрисовка (стены, спрайты, HUD)
│   ├── map.js          # Карты уровней
│   ├── enemies.js      # Враги, AI
│   ├── weapons.js      # Оружие, стрельба
│   ├── items.js        # Предметы, подбор
│   ├── sprites.js      # Система спрайтов
│   ├── ui.js           # Меню, экраны
│   ├── audio.js        # Звук
│   └── levels.js       # Система уровней, переходы
├── assets/
│   ├── textures/       # Текстуры стен (можно генерировать программно)
│   ├── sprites/        # Спрайты врагов/предметов
│   └── sounds/         # Звуки
├── tests/
│   └── test-runner.html  # Автотесты
└── tasks.md            # Декомпозиция задач
```

## Полное ТЗ игры

# Zero Tolerance — Game Design Document (Product Specification)

---

## 1. Общее описание продукта

**Название:** Zero Tolerance
**Платформа:** Sega Mega Drive / Genesis
**Жанр:** First-Person Shooter (FPS)
**Сеттинг:** Научная фантастика, ближнее будущее
**Целевая аудитория:** Хардкорные игроки 14+
**Референсы:** DOOM, Wolfenstein 3D (адаптация концепции FPS под 16-битное железо)

### Краткий питч

Шутер от первого лица на 16-битной консоли. Игрок управляет бойцами элитного отряда «Zero Tolerance», зачищая этаж за этажом космическую станцию, небоскрёб корпорации и подземный комплекс от инопланетных захватчиков и заражённых людей. Акцент на атмосфере, исследовании и выживании в условиях ограниченных ресурсов.

---

## 2. Сюжетная рамка (Narrative Framework)

### 2.1. Предыстория

- Действие происходит в будущем. Человечество освоило околоземное пространство.
- Орбитальная космическая станция **«Europa-1»** — ключевой оборонный объект корпорации **Planet Defense Corps (PDC)**.
- На станцию проникают враждебные инопланетные организмы. Связь со станцией потеряна. Весь персонал предположительно мёртв или заражён.
- Заражение распространяется на наземный штаб PDC — высотное здание — и уходит в подземные уровни.

### 2.2. Завязка

Элитный отряд из 5 оперативников под кодовым названием **«Zero Tolerance»** получает приказ: нулевая терпимость к угрозе — уничтожить всех врагов, выяснить источник заражения и ликвидировать его.

### 2.3. Структура нарратива

Сюжет подаётся **минималистично**:
- Брифинг перед каждой локационной главой (текстовый экран).
- Короткие текстовые вставки между уровнями (опционально).
- Основное повествование — через окружение (environmental storytelling): трупы, разрушения, типы врагов, изменение обстановки.
- Финал — уничтожение источника заражения на самых нижних подземных уровнях.

---

## 3. Структура игры (Game Structure)

### 3.1. Общая архитектура

```
ГЛАВА 1: Космическая станция Europa-1 (~16 уровней)
    → Игрок спускается сверху вниз, с верхних палуб к стыковочным шлюзам
    
ГЛАВА 2: Небоскрёб штаба PDC (~16 уровней)
    → Игрок спускается с крыши здания через этажи к первому этажу
    
ГЛАВА 3: Подземный комплекс (~8 уровней)
    → Игрок спускается в подземные лаборатории/туннели к финальному боссу
```

**Итого: ~40 уровней**, объединённых логикой **вертикального спуска** — от верха к основанию и ниже.

### 3.2. Структура одного уровня

Каждый уровень представляет собой:
- **Замкнутую карту-лабиринт** (вид сверху — сетка), состоящую из коридоров, комнат, залов.
- **Цель уровня:** уничтожить **всех врагов** на этаже (счётчик оставшихся врагов отображается в HUD).
- Когда все враги уничтожены → открывается **лифт/переход** на следующий уровень.
- На уровне размещены: враги, предметы (аптечки, бронежилеты, оружие, боеприпасы), интерактивные элементы (двери, лифты).

### 3.3. Прогрессия и сложность

- **Ранние уровни (станция):** узкие коридоры, слабые враги, обучение механикам.
- **Средние уровни (небоскрёб):** более открытые пространства, разнообразнее враги, больше амбушей.
- **Поздние уровни (подземелье):** тёмные помещения, сильнейшие враги, дефицит ресурсов, босс-файты.

---

## 4. Персонажи игрока (Playable Characters)

### 4.1. Концепция отряда

Игроку доступны **5 оперативников**. Перед началом игры (и перед каждым уровнем, если предыдущий оперативник жив) игрок **выбирает одного** для миссии.

### 4.2. Параметры персонажей

Каждый оперативник имеет уникальную комбинацию характеристик:

| Параметр | Описание |
|---|---|
| **Health (HP)** | Запас здоровья. Разный у каждого бойца. |
| **Speed** | Скорость передвижения по уровню. |
| **Armor** | Базовая защита (снижение входящего урона). |
| **Стартовое оружие** | У каждого бойца своё начальное оружие. |

### 4.3. Список персонажей (5 бойцов)

| # | Имя (примерное) | Роль/Архетип | Особенность |
|---|---|---|---|
| 1 | Tony Ramos | Штурмовик | Сбалансированные характеристики, среднее оружие |
| 2 | Samantha Higgs | Разведчица | Высокая скорость, низкий HP |
| 3 | Justin Wolf | Тяжёлый боец | Много HP, тяжёлое оружие, медленный |
| 4 | Tomiko Ikeda | Инженер/Техник | Средние статы, уникальное оружие |
| 5 | Flex McCarthy | Сержант | Хорошая броня, среднее оружие |

> *Примечание для разработчиков: точные числовые значения — в отдельной таблице балансировки.*

### 4.4. Механика перманентной смерти (Permadeath)

**Критическая механика:**
- Если оперативник **погибает** (HP = 0), он **выбывает навсегда** из текущего прохождения.
- Игрок выбирает следующего бойца из оставшихся.
- Если **все 5 погибли** — **Game Over**.
- Это создаёт чувство ценности каждой жизни и тактической осторожности.
- Подобранное оружие и патроны **НЕ переносятся** между персонажами — каждый начинает со своим стартовым набором.

---

## 5. Геймплей — Core Loop

### 5.1. Основной игровой цикл

```
Войти на уровень
    → Исследовать карту (exploration)
    → Находить и уничтожать врагов (combat)
    → Собирать ресурсы: оружие, патроны, HP, броню (looting)
    → Уничтожить всех врагов на уровне (objective)
    → Перейти к лифту/выходу (extraction)
    → Следующий уровень
```

### 5.2. Управление и перемещение

**Вид:** от первого лица (First-Person Perspective).

**Управление (маппинг на геймпад Sega — 3 кнопки + D-pad):**

| Ввод | Действие |
|---|---|
| D-pad вверх | Движение вперёд |
| D-pad вниз | Движение назад |
| D-pad лево | Поворот влево |
| D-pad право | Поворот вправо |
| Кнопка A | Стрейф (боковое перемещение) — зажать + лево/право |
| Кнопка B | Стрельба |
| Кнопка C | Смена оружия (цикл) |
| Start | Пауза / Меню (карта) |

> *Опционально поддержка 6-кнопочного геймпада для расширенного маппинга (выделить стрейф на отдельные кнопки).*

### 5.3. Передвижение

- **Плоскостное перемещение** (нет прыжков, нет вертикального прицеливания — как Wolfenstein 3D).
- Все уровни — **одноэтажные** (flat), без перепадов высот.
- Поворот — дискретными или полу-плавными шагами (зависит от производительности).
- **Стрейф** — критически важная механика для уклонения от вражеских снарядов.
- Скорость передвижения зависит от выбранного персонажа.

---

## 6. Система боя (Combat System)

### 6.1. Стрельба

- **Auto-aim по вертикали:** все враги считаются на одной высоте с игроком, наведение только по горизонтальной оси.
- Игрок стреляет точно в центр экрана (crosshair фиксирован по центру).
- У каждого оружия свои параметры (см. таблицу ниже).
- Враги реагируют на попадания (hit reaction — анимация/звук).
- Дальность отрисовки и поражения ограничена (fog of distance).

### 6.2. Арсенал оружия

| # | Оружие | Тип | Боеприпасы | Урон | Скорострельность | Примечания |
|---|---|---|---|---|---|---|
| 1 | Пистолет (Handgun) | Полуавтомат | Пули (pistol ammo) | Низкий | Средняя | Стартовое у нескольких персонажей. Надёжное. |
| 2 | Дробовик (Shotgun) | Одиночные выстрелы | Патроны (shells) | Высокий (ближний) | Низкая | Эффективен вблизи, разброс. |
| 3 | Автомат (Assault Rifle) | Автоматический | Пули (rifle ammo) | Средний | Высокая | Основное боевое оружие. |
| 4 | Пулемёт (Machine Gun) | Автоматический | Ленты (belt ammo) | Средний | Очень высокая | Расходует боеприпасы быстро. |
| 5 | Ракетница (Rocket Launcher) | Одиночные | Ракеты | Очень высокий | Очень низкая | Урон по площади. Осторожно — самоповреждение! |
| 6 | Огнемёт (Flamethrower) | Непрерывный | Топливо | Высокий (DoT) | Непрерывная | Эффективен против групп. |
| 7 | Лазерное оружие (Laser) | Полуавтомат | Энергия (cells) | Высокий | Средняя | Найти на поздних уровнях. |

> *Балансные значения урона/расхода — в отдельном документе.*

### 6.3. Подбираемые предметы (Pickups)

| Предмет | Эффект |
|---|---|
| Аптечка малая | Восстанавливает ~25% HP |
| Аптечка большая | Восстанавливает ~50-100% HP |
| Бронежилет | Добавляет очки брони / снижение урона |
| Боеприпасы (разных типов) | Пополнение патронов к соответствующему оружию |
| Оружие (на полу / у стен) | Подбор нового оружия + немного патронов к нему |

---

## 7. Враги (Enemy Design)

### 7.1. Принципы

- Враги **размещены статически** на уровне (заскриптованные позиции) или совершают **простой патруль** по маршруту.
- При обнаружении игрока (line of sight) — **агрятся**, начинают движение к игроку и/или стрельбу.
- У врагов есть **HP, тип атаки (ближняя/дальняя), скорость**.
- Враги **не открывают двери** (ограничение AI).

### 7.2. Типы врагов

#### Глава 1 — Станция Europa-1:

| Враг | Описание | Атака | Опасность |
|---|---|---|---|
| Заражённый человек (Zombie crew) | Бывший экипаж, медленно бредёт к игроку | Ближняя (удар) | ★☆☆☆☆ |
| Вооружённый заражённый | Человек с оружием, стреляет | Дальняя (пистолет) | ★★☆☆☆ |
| Малый ксеноморф (Small alien) | Быстрое мелкое существо, бежит к игроку | Ближняя (укус) | ★★☆☆☆ |
| Солдат-мутант | Бронированный гуманоид с автоматом | Дальняя (автомат) | ★★★☆☆ |

#### Глава 2 — Небоскрёб:

| Враг | Описание | Атака | Опасность |
|---|---|---|---|
| Боевой дрон | Летающий робот (визуально — на уровне глаз) | Дальняя (лазер) | ★★★☆☆ |
| Тяжёлый мутант | Крупный, толстый, медленный, много HP | Ближняя/дальняя | ★★★★☆ |
| Элитный солдат | Быстрый, уклоняется, хорошая точность | Дальняя (автомат) | ★★★★☆ |
| Инопланетный воин | Сильный враг-пришелец с энергооружием | Дальняя (плазма) | ★★★★☆ |

#### Глава 3 — Подземелье:

| Враг | Описание | Атака | Опасность |
|---|---|---|---|
| Крупный ксеноморф | Большой агрессивный пришелец | Ближняя (мощный удар) | ★★★★☆ |
| Элитный инопланетянин | Стреляет тяжёлыми снарядами | Дальняя | ★★★★★ |
| **Босс (финальный)** | Огромное существо-источник заражения | Комбо-атаки | ★★★★★ |

### 7.3. AI (логика поведения)

```
Состояния:
  IDLE → стоит на месте / патрулирует точку
  ALERT → игрок в зоне видимости / звук выстрела → переход в CHASE
  CHASE → движение к игроку по прямой (нет pathfinding вокруг препятствий, 
           только базовые повороты)
  ATTACK → в радиусе атаки → стрелять / бить
  PAIN → получил урон → короткая пауза (hit stun) → обратно в ATTACK/CHASE
  DEATH → HP ≤ 0 → анимация смерти → удаление спрайта
```

> AI предельно простой из-за ограничений платформы. Компенсируется количеством врагов и их размещением (засады за углами, в тёмных комнатах).

---

## 8. Дизайн уровней (Level Design)

### 8.1. Технический формат карт

- Карта уровня — **2D-сетка** (grid-based), как в Wolfenstein 3D.
- Каждая ячейка сетки = стена (разной текстуры) или проходимое пространство (пол).
- Двери — специальный тип ячейки (анимация открытия при подходе или по нажатию кнопки).
- **Нет перепадов высот**, нет лестниц внутри уровня.
- Переход между уровнями — только через лифт (специальный триггер-объект).

### 8.2. Принципы проектирования уровней

1. **Нелинейность внутри уровня:** Несколько путей к разным зонам. Игрок сам выбирает порядок зачистки.
2. **Тупики с наградами:** Отклонение от основного маршрута → лут (оружие, HP).
3. **Засады:** Враги за дверями, за углами, в тёмных зонах.
4. **Читаемая тематика:** Каждая глава имеет уникальный набор текстур стен/пола/потолка:
   - Станция: металлические панели, трубы, иллюминаторы, технические помещения.
   - Небоскрёб: офисные стены, бетон, стекло, корпоративные интерьеры.
   - Подземелье: грунт, камень, биоорганические текстуры, лаборатории.
5. **Нарастающий размер:** Ранние уровни — маленькие (обучение). Поздние — большие лабиринты.

### 8.3. Карта (Automap)

- По нажатию Start (или отдельной кнопки) открывается **карта уровня вид сверху**.
- Отображается:
  - Уже посещённые зоны (explored).
  - Позиция игрока и направление взгляда.
  - Двери.
- **НЕ отображаются:** враги, предметы (для сохранения интриги).

---

## 9. Рендеринг и технические требования

### 9.1. Окно рендеринга

**КРИТИЧЕСКИ ВАЖНО:**

Из-за ограничений процессора Motorola 68000 (7.6 MHz) полноэкранный 3D-рендер невозможен с приемлемым FPS.

Решение:
- **3D-окно рендеринга занимает примерно 50-60% площади экрана** (центральное окно).
- Вокруг окна рендеринга — **статичная рамка HUD** с информацией (см. раздел 10).
- Целевой FPS: **15-20 кадров в секунду** (приемлемо для платформы).

### 9.2. Рендер-движок

- **Raycasting** (как Wolfenstein 3D), НЕ BSP (как DOOM).
- Стены — вертикальные, строго 90°.
- Текстурирование стен — **да** (mapped textures на стены).
- Пол и потолок — **однотонная заливка** или простая текстура (для экономии ресурсов).
- Враги и предметы — **2D-спрайты** (billboarded), всегда лицом к камере.
- **Sprites врагов:** несколько углов обзора (фронт, бок, спина — минимум 4-8 углов) **ИЛИ** только фронтальный вид (для экономии ROM).
- Затемнение (distance shading): объекты вдали темнее — создаёт ощущение глубины и атмосферы + скрывает ограничение дальности отрисовки.

### 9.3. Разрешение и палитра

- Разрешение рендер-окна: **~160×120 пикселей** (масштабируется аппаратно).
- Общее разрешение экрана: **320×224** (стандарт Mega Drive).
- Палитра: 64 цвета на экране из 512 (ограничения VDP Mega Drive).

### 9.4. Звук

- **Звуковой чип:** Yamaha YM2612 (FM-синтез) + SN76489 (PSG).
- **Музыка:** Фоновые треки в стиле dark ambient / industrial. Создают напряжение. Уникальные треки для каждой главы (минимум 3 трека + 1 трек босс-файта).
- **Звуковые эффекты (SFX):**
  - Выстрелы (уникальный звук для каждого типа оружия).
  - Попадание по врагу (хит-маркер).
  - Смерть врага (крик/звук).
  - Открытие двери.
  - Подбор предмета.
  - Шаги игрока.
  - Получение урона игроком.
  - Звук лифта.
  - Ambient-звуки (гул станции, капающая вода и т.п.).

---

## 10. HUD (Head-Up Display)

### 10.1. Расположение

HUD располагается **вокруг 3D-окна** в виде рамки. Это позволяет:
- Уменьшить 3D-окно (производительность).
- Дать игроку всю информацию без оверлея.

### 10.2. Элементы HUD

```
┌────────────────────────────────────┐
│  SCORE    ENEMIES LEFT: 12         │
│ ┌──────────────────────────────┐   │
│ │                              │   │
│ │       3D VIEWPORT            │   │
│ │                              │   │
│ │                              │   │
│ └──────────────────────────────┘   │
│  HP: ████████░░  ARMOR: ███░░░░░  │
│  WEAPON: Shotgun   AMMO: 24       │
│  [Лицо персонажа]                 │
└────────────────────────────────────┘
```

| Элемент | Описание |
|---|---|
| **HP-бар** | Полоска/число текущего здоровья |
| **Armor** | Текущее значение брони |
| **Weapon** | Иконка/название текущего оружия |
| **Ammo** | Количество боеприпасов для текущего оружия |
| **Enemies Left** | Счётчик оставшихся врагов на уровне (ключевой элемент — игрок всегда знает, сколько ещё зачищать) |
| **Портрет персонажа** | Лицо текущего оперативника. При получении урона — лицо «реагирует» (как в DOOM) |
| **Мини-компас** | (Опционально) Направление взгляда |

---

## 11. Система сохранения

### 11.1. Система паролей

- На Sega Mega Drive нет встроенного сохранения (нет батарейки в стандартном картридже, если не предусмотрен SRAM).
- Используется **система паролей:**
  - После каждого пройденного уровня (или каждые N уровней) игроку показывается **буквенно-цифровой пароль**.
  - Пароль кодирует: текущий уровень, живых персонажей, (опционально) набранные очки.
  - В главном меню — пункт **«Password»** для ввода.

---

## 12. Мультиплеер (Уникальная фича)

### 12.1. Режим Link-Play на 2 игрока

**Уникальное торговое преимущество (USP):**

Возможность **соединить две консоли Sega Mega Drive** через специальный кабель (link cable) для **кооперативного или дезматч-режима**.

### 12.2. Технические требования для мультиплеера

- **2 консоли Sega Mega Drive.**
- **2 телевизора.**
- **2 картриджа** Zero Tolerance.
- **Link-кабель** (специальный, подключаемый через порт 2 контроллера — EXT port).

### 12.3. Режимы мультиплеера

| Режим | Описание |
|---|---|
| **Deathmatch** | Оба игрока на одной карте. Цель — фраги. Каждый на своём экране (на своём ТВ). |
| **Co-op** | (Если реализуемо) Совместная зачистка уровней. |

---

## 13. Меню и UI Flow

### 13.1. Главное меню

```
ZERO TOLERANCE

► NEW GAME
► PASSWORD
► OPTIONS
```

### 13.2. Options

```
OPTIONS

► SOUND TEST
► CONTROLS (если есть альтернативные раскладки)
► DIFFICULTY (Easy / Normal / Hard) — если предусмотрены уровни сложности
```

### 13.3. Экран выбора персонажа

```
SELECT OPERATIVE

[Портрет 1] Tony Ramos    — ALIVE
[Портрет 2] Samantha Higgs — ALIVE
[Портрет 3] Justin Wolf   — ALIVE
[Портрет 4] Tomiko Ikeda  — ALIVE
[Портрет 5] Flex McCarthy  — ALIVE

SPEED: ████░░░░  HP: ██████░░  ARMOR: ███░░░░░
```

Если персонаж мёртв — его портрет перечёркнут / затемнён, выбор невозможен.

### 13.4. Экран смерти персонажа

```
TONY RAMOS — K.I.A.

[Портрет перечёркнут]

REMAINING OPERATIVES: 4

► SELECT NEXT OPERATIVE
```

### 13.5. Game Over

```
ALL OPERATIVES K.I.A.

MISSION FAILED.

GAME OVER

► CONTINUE (enter password)
► MAIN MENU
```

---

## 14. Прогрессия и экономика (Balancing Notes)

### 14.1. Кривая сложности

```
Уровень:  1----5----10----15----20----25----30----35----40
Сложность: ▁▂▂▃▃▄▅▅▆▆▇▇█████████████████████
           |         |              |              |
           Обучение  Средняя        Хардкор        Финальный босс
```

### 14.2. Экономика ресурсов

- **Раннние уровни:** Щедрый лут. Игрок чувствует себя мощным. Обучение механикам.
- **Средние уровни:** Лут сбалансирован. Нужно экономить патроны для сильного оружия.
- **Поздние уровни:** Дефицит. Аптечки редки. Патроны к ракетнице/лазеру — ценность. Тактический выбор оружия.

### 14.3. Важные балансные правила

1. Пистолет имеет **бесконечные патроны** (fallback weapon, чтобы игрок не застрял).
2. Сильное оружие (ракетница, лазер) появляется **только с середины игры**.
3. Урон по площади от ракетницы бьёт и игрока — нельзя стрелять в упор.

---

## 15. Уникальные особенности продукта (Selling Points)

Для маркетинговых материалов и pitch-документов:

1. ✅ **FPS на Sega Mega Drive** — технологический прорыв для платформы. Минимальная конкуренция в жанре.
2. ✅ **40 уровней** — большой объём контента.
3. ✅ **5 уникальных персонажей с перманентной смертью** — добавляет тактическую глубину и реиграбельность.
4. ✅ **Мультиплеер через link-cable** — уникально для жанра на этой платформе.
5. ✅ **Атмосфера sci-fi хоррора** — тёмные коридоры, чужие, изоляция.
6. ✅ **Счётчик врагов** — чёткая цель на каждом уровне, удовлетворение от зачистки.

---

## 16. Технические ограничения и требования к оптимизации

| Ограничение | Решение |
|---|---|
| CPU 7.6 MHz — медленный для 3D | Уменьшенное окно рендера, raycasting, distance clipping |
| 64 KB RAM | Уровни подгружаются с картриджа, минимум данных в RAM |
| ROM-картридж до 8 Mbit (1 MB) | Оптимизация текстур (повторное использование), компрессия данных карт |
| Нет аппаратного 3D | Полностью софтверный рендер, ассемблер 68000 для критических путей |
| Ограниченные спрайты VDP | Враги рендерятся как часть framebuffer, НЕ как аппаратные спрайты |

---

## 17. Контент-план и объём работ (Scope Summary)

| Категория | Количество |
|---|---|
| Уровни | ~40 |
| Играбельные персонажи | 5 |
| Типы врагов | 12-15 |
| Боссы | 1-3 |
| Виды оружия | 7-8 |
| Типы предметов (pickups) | 6-8 |
| Текстуры стен (уникальные) | 30-50 |
| Музыкальные треки | 5-8 |
| Звуковые эффекты | 20-30 |

---

## 18. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|---|---|---|---|
| FPS ниже 10 — неиграбельно | Высокая | Критическое | Уменьшать окно рендера, оптимизировать на ассемблере, упрощать уровни |
| Однообразие 40 уровней | Средняя | Высокое | Разнообразие текстур, врагов, компоновки; три разные локации |
| Сложность мультиплеера (link-cable) | Средняя | Среднее | Реализовать мультиплеер последним; при проблемах — вырезать фичу |
| Память картриджа не хватит | Средняя | Высокое | Компрессия, переиспользование ассетов, процедурная генерация элементов |